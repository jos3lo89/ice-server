generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum user_role {
  ADMIN
  CAJERO
  MESERO
  BARTENDER
  COCINERO
}

enum table_status {
  LIBRE
  OCUPADA
  RESERVADA
  LIMPIEZA
}

enum order_status {
  ABIERTA
  CERRADA
  PARCIALMENTE_PAGADA
  EN_PAGO_DIVIDIDO
  PAGADA
  CANCELADA
}

enum order_item_status {
  PENDIENTE
  ENVIADO
  EN_PREPARACION
  LISTO
  ENTREGADO
}

enum payment_method {
  EFECTIVO
  TARJETA_VISA
  TARJETA_MASTERCARD
  TARJETA_AMEX
  YAPE
  PLIN
  TRANSFERENCIA
}

enum comprobante_type {
  TICKET
  BOLETA
  FACTURA
}

enum estado_sunat {
  NO_APLICA
  PENDIENTE
  ENVIANDO
  ACEPTADO
  RECHAZADO
  OBSERVADO
  ANULADO
}

enum tipo_documento_identidad {
  SIN_DOC
  DNI
  CARNET_EXT
  RUC
  PASAPORTE
}

enum area_preparacion {
  COCINA
  BAR
  BEBIDAS
  CAJA
}

enum cash_register_status {
  ABIERTA
  CERRADA
}

enum cash_movement_type {
  INGRESO
  EGRESO
}

enum tipo_nota_credito {
  ANULACION_OPERACION
  ANULACION_ERROR_RUC
  CORRECCION_DESCRIPCION
  DESCUENTO_GLOBAL
  DESCUENTO_ITEM
  DEVOLUCION_TOTAL
  DEVOLUCION_ITEM
  BONIFICACION
  DISMINUCION_VALOR
  OTROS
}

// ============================================
// MODELS
// ============================================

/// Configuración del sistema (key-value)
model system_config {
  key         String   @id @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.VarChar(500)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)
}

/// Correlativos de comprobantes SUNAT
model correlatives {
  id                 String   @id @default(uuid()) @db.Uuid
  tipo_documento     String   @db.VarChar(2)
  serie              String   @db.VarChar(4)
  correlativo_actual Int      @default(0)
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  updated_at         DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([tipo_documento, serie])
}

/// Pisos del restaurante
model floors {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(100)
  level       Int      @unique
  description String?  @db.VarChar(255)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  tables      tables[]
  user_floors user_floors[]
}

/// Impresoras térmicas
model printers {
  id              String           @id @default(uuid()) @db.Uuid
  name            String           @db.VarChar(100)
  type            String           @db.VarChar(50)
  connection_type String           @db.VarChar(20)
  address         String?          @db.VarChar(255)
  area            area_preparacion
  is_default      Boolean          @default(false)
  is_active       Boolean          @default(true)
  created_at      DateTime         @default(now()) @db.Timestamptz(6)
  updated_at      DateTime         @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  order_items order_items[]
}

/// Usuarios del sistema
model users {
  id                    String    @id @default(uuid()) @db.Uuid
  name                  String    @db.VarChar(255)
  dni                   String    @unique @db.VarChar(8)
  username              String    @unique @db.VarChar(50)
  password_hash         String    @db.VarChar(255)
  refreshToken          String?   @db.Text
  role                  user_role @default(MESERO)
  pin                   String?   @db.VarChar(6)
  is_active             Boolean   @default(true)
  last_login_at         DateTime? @db.Timestamptz(6)
  last_login_ip         String?   @db.VarChar(45)
  failed_login_attempts Int       @default(0)
  locked_until          DateTime? @db.Timestamptz(6)
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  updated_at            DateTime  @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  user_floors            user_floors[]
  orders                 orders[]
  order_items_created    order_items[]    @relation("CreatedBy")
  order_items_cancelled  order_items[]    @relation("CancelledBy")
  cash_registers         cash_registers[]
  cash_movements         cash_movements[]
  payments               payments[]
  sales                  sales[]
  credit_notes           credit_notes[]
  audit_logs             audit_logs[]
  reservations_created   reservations[]   @relation("ReservationCreator")
  reservations_confirmed reservations[]   @relation("ReservationConfirmer")
  reservations_cancelled reservations[]   @relation("ReservationCanceller")
}

/// Relación usuarios-pisos (muchos a muchos)
model user_floors {
  user_id  String @db.Uuid
  floor_id String @db.Uuid

  user  users  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  floor floors @relation(fields: [floor_id], references: [id], onDelete: Cascade)

  @@id([user_id, floor_id])
}

/// Categorías de productos (jerárquica)
model categories {
  id            String           @id @default(uuid()) @db.Uuid
  name          String           @db.VarChar(100)
  slug          String           @unique @db.VarChar(100)
  description   String?          @db.VarChar(255)
  parent_id     String?          @db.Uuid
  level         Int              @default(0)
  default_area  area_preparacion @default(COCINA)
  display_order Int              @default(0)
  icon          String?          @db.VarChar(50)
  color         String?          @db.VarChar(7)
  image_path    String?          @db.VarChar(500)
  is_active     Boolean          @default(true)
  created_at    DateTime         @default(now()) @db.Timestamptz(6)
  updated_at    DateTime         @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  parent   categories?  @relation("CategoryHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children categories[] @relation("CategoryHierarchy")
  products products[]

  @@index([parent_id], name: "idx_categories_parent")
  @@index([slug], name: "idx_categories_slug")
}

/// Productos del menú
model products {
  id               String           @id @default(uuid()) @db.Uuid
  category_id      String           @db.Uuid
  name             String           @unique @db.VarChar(255)
  short_name       String?          @db.VarChar(50)
  description      String?          @db.Text
  price            Decimal          @db.Decimal(10, 2)
  cost             Decimal          @default(0) @db.Decimal(10, 2)
  unidad_medida    String           @default("NIU") @db.VarChar(3)
  codigo_producto  String?          @db.VarChar(30)
  afectacion_igv   String           @default("10") @db.VarChar(2)
  aplica_icbper    Boolean          @default(false)
  area_preparacion area_preparacion
  is_stock_managed Boolean          @default(false)
  stock_actual     Int              @default(0)
  stock_minimo     Int              @default(0)
  image_path       String?          @db.VarChar(500)
  display_order    Int              @default(0)
  is_available     Boolean          @default(true)
  is_active        Boolean          @default(true)
  is_featured      Boolean          @default(false)
  created_at       DateTime         @default(now()) @db.Timestamptz(6)
  updated_at       DateTime         @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  category          categories          @relation(fields: [category_id], references: [id])
  variant_groups    variant_groups[]
  order_items       order_items[]
  sale_items        sale_items[]
  credit_note_items credit_note_items[]

  @@index([category_id], name: "idx_products_category")
  @@index([area_preparacion], name: "idx_products_area")
  @@index([is_active, is_available], name: "idx_products_active")
}

/// Grupos de variantes de productos
model variant_groups {
  id             String   @id @default(uuid()) @db.Uuid
  product_id     String   @db.Uuid
  name           String   @db.VarChar(100)
  is_required    Boolean  @default(false)
  max_selections Int      @default(1)
  display_order  Int      @default(0)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  product products          @relation(fields: [product_id], references: [id], onDelete: Cascade)
  options variant_options[]

  @@index([product_id], name: "idx_variant_groups_product")
}

/// Opciones de variantes
model variant_options {
  id               String   @id @default(uuid()) @db.Uuid
  variant_group_id String   @db.Uuid
  name             String   @db.VarChar(100)
  price_modifier   Decimal  @default(0) @db.Decimal(10, 2)
  is_default       Boolean  @default(false)
  is_active        Boolean  @default(true)
  display_order    Int      @default(0)
  created_at       DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  variant_group variant_groups @relation(fields: [variant_group_id], references: [id], onDelete: Cascade)

  @@index([variant_group_id], name: "idx_variant_options_group")
}

/// Mesas del restaurante
model tables {
  id         String       @id @default(uuid()) @db.Uuid
  floor_id   String       @db.Uuid
  number     Int
  name       String?      @db.VarChar(50)
  capacity   Int          @default(10)
  status     table_status @default(LIBRE)
  pos_x      Int          @default(0)
  pos_y      Int          @default(0)
  is_active  Boolean      @default(true)
  created_at DateTime     @default(now()) @db.Timestamptz(6)
  updated_at DateTime     @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  floor        floors         @relation(fields: [floor_id], references: [id], onDelete: Cascade)
  orders       orders[]
  reservations reservations[]

  @@unique([floor_id, number])
  @@index([floor_id, status], name: "idx_tables_floor_status")
}

/// Clientes para facturación
model clients {
  id               String                   @id @default(uuid()) @db.Uuid
  tipo_documento   tipo_documento_identidad @default(SIN_DOC)
  numero_documento String                   @db.VarChar(15)
  razon_social     String                   @db.VarChar(500)
  nombre_comercial String?                  @db.VarChar(255)
  direccion        String?                  @db.VarChar(500)
  ubigeo           String?                  @db.VarChar(6)
  email            String?                  @db.VarChar(100)
  telefono         String?                  @db.VarChar(20)
  total_purchases  Decimal                  @default(0) @db.Decimal(12, 2)
  visit_count      Int                      @default(0)
  last_visit_at    DateTime?                @db.Timestamptz(6)
  is_active        Boolean                  @default(true)
  created_at       DateTime                 @default(now()) @db.Timestamptz(6)
  updated_at       DateTime                 @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  sales        sales[]
  credit_notes credit_notes[]

  @@unique([tipo_documento, numero_documento])
  @@index([numero_documento], name: "idx_clients_documento")
}

/// Órdenes (comandas)
model orders {
  id                  String       @id @default(uuid()) @db.Uuid
  daily_number        Int
  order_date          DateTime     @default(now()) @db.Date
  table_id            String       @db.Uuid
  user_id             String       @db.Uuid
  status              order_status @default(ABIERTA)
  diners_count        Int          @default(1)
  notes               String?      @db.Text
  subtotal            Decimal      @default(0) @db.Decimal(12, 2)
  total_cancelled     Decimal      @default(0) @db.Decimal(12, 2)
  total_paid          Decimal      @default(0) @db.Decimal(12, 2)
  total_pending       Decimal      @default(0) @db.Decimal(12, 2)
  is_split_payment    Boolean      @default(false)
  split_payment_count Int          @default(0)
  created_at          DateTime     @default(now()) @db.Timestamptz(6)
  updated_at          DateTime     @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  table         tables          @relation(fields: [table_id], references: [id])
  user          users           @relation(fields: [user_id], references: [id])
  order_items   order_items[]
  payments      payments[]
  sales         sales[]
  order_history order_history[]

  @@unique([daily_number, order_date])
  @@index([order_date, daily_number], name: "idx_orders_date")
  @@index([table_id, status], name: "idx_orders_table")
  @@index([user_id], name: "idx_orders_user")
}

/// Items de orden (productos pedidos)
model order_items {
  id                 String            @id @default(uuid()) @db.Uuid
  order_id           String            @db.Uuid
  product_id         String            @db.Uuid
  product_name       String            @db.VarChar(255)
  product_short_name String?           @db.VarChar(50)
  quantity           Int               @default(1)
  unit_price         Decimal           @db.Decimal(10, 2)
  variants_snapshot  Json?             @db.JsonB
  variants_total     Decimal           @default(0) @db.Decimal(10, 2)
  line_total         Decimal           @db.Decimal(10, 2)
  status             order_item_status @default(PENDIENTE)
  area_preparacion   area_preparacion
  sent_to_kitchen_at DateTime?         @db.Timestamptz(6)
  printed_at         DateTime?         @db.Timestamptz(6)
  printer_id         String?           @db.Uuid
  notes              String?           @db.Text
  is_cancelled       Boolean           @default(false)
  cancelled_at       DateTime?         @db.Timestamptz(6)
  cancelled_by       String?           @db.Uuid
  cancel_reason      String?           @db.Text
  quantity_paid      Int               @default(0)
  amount_paid        Decimal           @default(0) @db.Decimal(12, 2)
  is_paid            Boolean           @default(false)
  paid_at            DateTime?         @db.Timestamptz(6)
  payment_id         String?           @db.Uuid
  created_by         String            @db.Uuid
  created_at         DateTime          @default(now()) @db.Timestamptz(6)
  updated_at         DateTime          @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  order         orders          @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product       products        @relation(fields: [product_id], references: [id])
  printer       printers?       @relation(fields: [printer_id], references: [id])
  creator       users           @relation("CreatedBy", fields: [created_by], references: [id])
  canceller     users?          @relation("CancelledBy", fields: [cancelled_by], references: [id])
  payment_items payment_items[]
  sale_items    sale_items[]

  @@index([order_id], name: "idx_order_items_order")
  @@index([status, area_preparacion], name: "idx_order_items_status")
  @@index([product_id], name: "idx_order_items_product")
}

/// Caja registradora
model cash_registers {
  id              String               @id @default(uuid()) @db.Uuid
  user_id         String               @db.Uuid
  open_time       DateTime             @default(now()) @db.Timestamptz(6)
  close_time      DateTime?            @db.Timestamptz(6)
  initial_amount  Decimal              @db.Decimal(12, 2)
  total_sales     Decimal              @default(0) @db.Decimal(12, 2)
  total_income    Decimal              @default(0) @db.Decimal(12, 2)
  total_expense   Decimal              @default(0) @db.Decimal(12, 2)
  expected_amount Decimal              @default(0) @db.Decimal(12, 2)
  final_amount    Decimal?             @db.Decimal(12, 2)
  difference      Decimal?             @db.Decimal(12, 2)
  status          cash_register_status @default(ABIERTA)
  notes           String?              @db.Text
  created_at      DateTime             @default(now()) @db.Timestamptz(6)
  updated_at      DateTime             @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  user           users            @relation(fields: [user_id], references: [id])
  cash_movements cash_movements[]
  payments       payments[]
  sales          sales[]

  @@index([status], name: "idx_cash_registers_status")
  @@index([user_id], name: "idx_cash_registers_user")
}

/// Movimientos de caja
model cash_movements {
  id               String             @id @default(uuid()) @db.Uuid
  cash_register_id String             @db.Uuid
  type             cash_movement_type
  amount           Decimal            @db.Decimal(12, 2)
  description      String             @db.Text
  is_automatic     Boolean            @default(false)
  payment_id       String?            @db.Uuid
  created_by       String             @db.Uuid
  created_at       DateTime           @default(now()) @db.Timestamptz(6)

  // Relaciones
  cash_register cash_registers @relation(fields: [cash_register_id], references: [id], onDelete: Cascade)
  creator       users          @relation(fields: [created_by], references: [id])

  @@index([cash_register_id], name: "idx_cash_movements_register")
}

/// Pagos (completos o parciales)
model payments {
  id               String         @id @default(uuid()) @db.Uuid
  order_id         String         @db.Uuid
  cash_register_id String         @db.Uuid
  payment_number   Int
  amount           Decimal        @db.Decimal(12, 2)
  payment_method   payment_method
  amount_received  Decimal?       @db.Decimal(12, 2)
  change_given     Decimal?       @db.Decimal(12, 2)
  payer_name       String?        @db.VarChar(255)
  payer_notes      String?        @db.Text
  sale_id          String?        @db.Uuid
  processed_by     String         @db.Uuid
  created_at       DateTime       @default(now()) @db.Timestamptz(6)

  // Relaciones
  order         orders          @relation(fields: [order_id], references: [id])
  cash_register cash_registers  @relation(fields: [cash_register_id], references: [id])
  processor     users           @relation(fields: [processed_by], references: [id])
  payment_items payment_items[]
  sale          sales?

  @@index([order_id], name: "idx_payments_order")
  @@index([cash_register_id], name: "idx_payments_cash_register")
}

/// Items cubiertos por cada pago
model payment_items {
  id            String   @id @default(uuid()) @db.Uuid
  payment_id    String   @db.Uuid
  order_item_id String   @db.Uuid
  quantity_paid Int
  amount        Decimal  @db.Decimal(12, 2)
  created_at    DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  payment    payments    @relation(fields: [payment_id], references: [id], onDelete: Cascade)
  order_item order_items @relation(fields: [order_item_id], references: [id])

  @@unique([payment_id, order_item_id])
  @@index([payment_id], name: "idx_payment_items_payment")
  @@index([order_item_id], name: "idx_payment_items_order_item")
}

/// Ventas / Comprobantes
model sales {
  id                 String           @id @default(uuid()) @db.Uuid
  tipo_comprobante   comprobante_type
  serie              String           @db.VarChar(4)
  correlativo        Int
  numero_completo    String           @unique @db.VarChar(15)
  fecha_emision      DateTime         @default(now()) @db.Timestamptz(6)
  fecha_vencimiento  DateTime?        @db.Timestamptz(6)
  tipo_moneda        String           @default("PEN") @db.VarChar(3)
  order_id           String?          @db.Uuid
  payment_id         String?          @unique @db.Uuid
  client_id          String?          @db.Uuid
  user_id            String           @db.Uuid
  cash_register_id   String?          @db.Uuid
  payment_method     payment_method
  forma_pago         String           @default("Contado") @db.VarChar(20)
  monto_gravado      Decimal          @default(0) @db.Decimal(12, 2)
  monto_exonerado    Decimal          @default(0) @db.Decimal(12, 2)
  monto_inafecto     Decimal          @default(0) @db.Decimal(12, 2)
  monto_gratuito     Decimal          @default(0) @db.Decimal(12, 2)
  monto_igv          Decimal          @default(0) @db.Decimal(12, 2)
  monto_icbper       Decimal          @default(0) @db.Decimal(12, 2)
  total_impuestos    Decimal          @default(0) @db.Decimal(12, 2)
  valor_venta        Decimal          @default(0) @db.Decimal(12, 2)
  precio_venta_total Decimal          @db.Decimal(12, 2)
  monto_pagado       Decimal?         @db.Decimal(12, 2)
  vuelto             Decimal?         @db.Decimal(12, 2)
  monto_letras       String?          @db.VarChar(500)
  estado_sunat       estado_sunat     @default(NO_APLICA)
  xml_path           String?          @db.VarChar(500)
  pdf_path           String?          @db.VarChar(500)
  cdr_path           String?          @db.VarChar(500)
  sunat_hash         String?          @db.VarChar(100)
  sunat_code         String?          @db.VarChar(10)
  sunat_description  String?          @db.Text
  created_at         DateTime         @default(now()) @db.Timestamptz(6)
  updated_at         DateTime         @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  order            orders?            @relation(fields: [order_id], references: [id])
  payment          payments?          @relation(fields: [payment_id], references: [id])
  client           clients?           @relation(fields: [client_id], references: [id])
  user             users              @relation(fields: [user_id], references: [id])
  cash_register    cash_registers?    @relation(fields: [cash_register_id], references: [id])
  sale_items       sale_items[]
  credit_notes     credit_notes[]
  voided_documents voided_documents[]

  @@index([fecha_emision], name: "idx_sales_fecha")
  @@index([numero_completo], name: "idx_sales_numero")
  @@index([order_id], name: "idx_sales_order")
  @@index([payment_id], name: "idx_sales_payment")
  @@index([client_id], name: "idx_sales_client")
}

/// Items de venta (detalle del comprobante)
model sale_items {
  id                    String   @id @default(uuid()) @db.Uuid
  sale_id               String   @db.Uuid
  order_item_id         String?  @db.Uuid
  product_id            String?  @db.Uuid
  codigo_producto       String?  @db.VarChar(30)
  descripcion           String   @db.VarChar(500)
  unidad_medida         String   @db.VarChar(3)
  cantidad              Decimal  @db.Decimal(12, 3)
  mto_valor_unitario    Decimal  @db.Decimal(12, 10)
  mto_precio_unitario   Decimal  @db.Decimal(12, 10)
  mto_valor_venta       Decimal  @db.Decimal(12, 2)
  afectacion_igv        String   @db.VarChar(2)
  porcentaje_igv        Decimal  @default(18.00) @db.Decimal(5, 2)
  mto_base_igv          Decimal  @default(0) @db.Decimal(12, 2)
  mto_igv               Decimal  @default(0) @db.Decimal(12, 2)
  mto_icbper            Decimal  @default(0) @db.Decimal(12, 2)
  total_impuestos       Decimal  @default(0) @db.Decimal(12, 2)
  variantes_descripcion String?  @db.Text
  created_at            DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  sale       sales        @relation(fields: [sale_id], references: [id], onDelete: Cascade)
  order_item order_items? @relation(fields: [order_item_id], references: [id])
  product    products?    @relation(fields: [product_id], references: [id])

  @@index([sale_id], name: "idx_sale_items_sale")
  @@index([product_id], name: "idx_sale_items_product")
}

/// Notas de crédito
model credit_notes {
  id              String            @id @default(uuid()) @db.Uuid
  client_id       String            @db.Uuid
  user_id         String            @db.Uuid
  serie           String            @db.VarChar(4)
  correlativo     String            @db.VarChar(8)
  numero_completo String            @unique @db.VarChar(15)
  fecha_emision   DateTime          @default(now()) @db.Timestamptz(6)
  sale_id         String?           @db.Uuid
  tipo_doc_ref    String            @db.VarChar(2)
  serie_ref       String            @db.VarChar(4)
  correlativo_ref String            @db.VarChar(8)
  tipo_nota       tipo_nota_credito
  motivo          String            @db.VarChar(500)
  valor_venta     Decimal           @default(0) @db.Decimal(12, 2)
  monto_igv       Decimal           @default(0) @db.Decimal(12, 2)
  total_impuestos Decimal           @default(0) @db.Decimal(12, 2)
  mto_imp_venta   Decimal           @db.Decimal(12, 2)
  xml_path        String?           @db.VarChar(500)
  pdf_path        String?           @db.VarChar(500)
  cdr_path        String?           @db.VarChar(500)
  estado_sunat    estado_sunat      @default(PENDIENTE)
  sunat_hash      String?           @db.VarChar(100)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  client            clients             @relation(fields: [client_id], references: [id])
  user              users               @relation(fields: [user_id], references: [id])
  sale              sales?              @relation(fields: [sale_id], references: [id])
  credit_note_items credit_note_items[]

  @@index([sale_id], name: "idx_credit_notes_sale")
  @@index([fecha_emision], name: "idx_credit_notes_fecha")
}

/// Items de nota de crédito
model credit_note_items {
  id                  String   @id @default(uuid()) @db.Uuid
  credit_note_id      String   @db.Uuid
  product_id          String?  @db.Uuid
  cantidad            Decimal  @db.Decimal(12, 3)
  unidad_medida       String   @db.VarChar(3)
  descripcion         String   @db.VarChar(500)
  mto_valor_unitario  Decimal  @db.Decimal(12, 10)
  mto_precio_unitario Decimal  @db.Decimal(12, 10)
  mto_valor_venta     Decimal  @db.Decimal(12, 2)
  afectacion_igv      String   @db.VarChar(2)
  mto_igv             Decimal  @default(0) @db.Decimal(12, 2)
  total_impuestos     Decimal  @default(0) @db.Decimal(12, 2)
  created_at          DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  credit_note credit_notes @relation(fields: [credit_note_id], references: [id], onDelete: Cascade)
  product     products?    @relation(fields: [product_id], references: [id])
}

/// Resúmenes diarios de boletas
model daily_summaries {
  id               String       @id @default(uuid()) @db.Uuid
  identificador    String       @unique @db.VarChar(20)
  fecha_emision    DateTime     @default(now()) @db.Date
  fecha_referencia DateTime     @db.Date
  sales_ids        String[]     @db.Uuid
  sales_count      Int
  total_amount     Decimal      @db.Decimal(12, 2)
  xml_path         String?      @db.VarChar(500)
  cdr_path         String?      @db.VarChar(500)
  estado_sunat     estado_sunat @default(PENDIENTE)
  ticket_sunat     String?      @db.VarChar(50)
  created_at       DateTime     @default(now()) @db.Timestamptz(6)
  updated_at       DateTime     @default(now()) @updatedAt @db.Timestamptz(6)
}

/// Documentos anulados (comunicación de baja)
model voided_documents {
  id               String       @id @default(uuid()) @db.Uuid
  identificador    String       @unique @db.VarChar(20)
  fecha_emision    DateTime     @default(now()) @db.Date
  fecha_referencia DateTime     @db.Date
  sale_id          String?      @db.Uuid
  tipo_documento   String       @db.VarChar(2)
  serie            String       @db.VarChar(4)
  correlativo      String       @db.VarChar(8)
  motivo           String       @db.VarChar(500)
  xml_path         String?      @db.VarChar(500)
  cdr_path         String?      @db.VarChar(500)
  estado_sunat     estado_sunat @default(PENDIENTE)
  ticket_sunat     String?      @db.VarChar(50)
  created_at       DateTime     @default(now()) @db.Timestamptz(6)
  updated_at       DateTime     @default(now()) @updatedAt @db.Timestamptz(6)

  // Relaciones
  sale sales? @relation(fields: [sale_id], references: [id])
}

/// Reservaciones
enum reservation_status {
  PENDIENTE
  CONFIRMADA
  CANCELADA
}

model reservations {
  id       String @id @default(uuid()) @db.Uuid
  table_id String @db.Uuid

  // Cliente
  client_name  String  @db.VarChar(255)
  client_phone String  @db.VarChar(20)
  client_email String? @db.VarChar(100)

  // Fecha y hora
  reservation_datetime DateTime @db.Timestamptz(6)
  end_datetime         DateTime @db.Timestamptz(6)
  duration_hours       Int      @default(2)

  // Detalles
  diners_count Int
  notes        String?            @db.Text
  status       reservation_status @default(PENDIENTE)

  // Auditoría - Creación
  created_by String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  // Auditoría - Confirmación
  confirmed_by String?   @db.Uuid
  confirmed_at DateTime? @db.Timestamptz(6)

  // Auditoría - Cancelación
  cancel_reason String?   @db.VarChar(500)
  cancelled_by  String?   @db.Uuid
  cancelled_at  DateTime? @db.Timestamptz(6)

  // Relaciones
  table     tables @relation(fields: [table_id], references: [id])
  creator   users  @relation("ReservationCreator", fields: [created_by], references: [id])
  confirmer users? @relation("ReservationConfirmer", fields: [confirmed_by], references: [id])
  canceller users? @relation("ReservationCanceller", fields: [cancelled_by], references: [id])

  @@index([reservation_datetime])
  @@index([table_id, status])
  @@index([status])
}

/// Historial de órdenes (para reportes)
model order_history {
  id                 String   @id @default(uuid()) @db.Uuid
  order_id           String   @db.Uuid
  order_daily_number Int
  order_date         DateTime @db.Date
  table_number       Int
  floor_name         String   @db.VarChar(100)
  waiter_name        String   @db.VarChar(255)
  total_amount       Decimal  @db.Decimal(12, 2)
  total_items        Int
  was_split_payment  Boolean  @default(false)
  payment_count      Int      @default(1)
  sales_generated    Json?    @db.JsonB
  opened_at          DateTime @db.Timestamptz(6)
  closed_at          DateTime @db.Timestamptz(6)
  duration_minutes   Int?
  created_at         DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  order orders @relation(fields: [order_id], references: [id])

  @@index([order_date], name: "idx_order_history_date")
  @@index([waiter_name], name: "idx_order_history_waiter")
}

/// Logs de auditoría
model audit_logs {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String?  @db.Uuid
  action      String   @db.VarChar(50)
  entity_type String   @db.VarChar(50)
  entity_id   String?  @db.Uuid
  old_values  Json?    @db.JsonB
  new_values  Json?    @db.JsonB
  ip_address  String?  @db.VarChar(45)
  user_agent  String?  @db.Text
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  // Relaciones
  user users? @relation(fields: [user_id], references: [id])

  @@index([entity_type, entity_id], name: "idx_audit_logs_entity")
  @@index([created_at(sort: Desc)], name: "idx_audit_logs_date")
  @@index([user_id], name: "idx_audit_logs_user")
}
