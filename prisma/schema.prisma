// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  CAJERO
  MESERO
}

enum CashMovementType {
  INGRESO
  EGRESO
}

enum TableStatus {
  LIBRE
  OCUPADA
  RESERVADA
}

enum OrderStatus {
  PENDIENTE
  EN_PREPARACION
  LISTO
  ENTREGADO
  CANCELADO
}

enum PaymentMethod {
  EFECTIVO
  TARJETA
  YAPE
  PLIN
  TRANSFERENCIA
}

enum ComprobanteType {
  TICKET // 00 - Nota de Venta
  BOLETA // 03 - Boleta de Venta Electrónica
  FACTURA // 01 - Factura Electrónica
}

enum CashRegisterStatus {
  ABIERTA
  CERRADA
}

enum AreaOrder {
  COCINA
  BEBIDAS
  BAR
}

enum EstadoSunat {
  PENDIENTE
  ENVIADO
  ACEPTADO
  RECHAZADO
  ANULADO
}

enum TipoDocumentoIdentidad {
  DNI // 1
  CARNET_EXT // 4
  RUC // 6
  PASAPORTE // 7
  SIN_DOC // 0
}

enum TipoNotaCredito {
  ANULACION_OPERACION // 01
  ANULACION_ERROR_RUC // 02
  CORRECCION_ERROR_DESCRIPCION // 03
  DESCUENTO_GLOBAL // 04
  DESCUENTO_ITEM // 05
  DEVOLUCION_TOTAL // 06
  DEVOLUCION_ITEM // 07
  BONIFICACION // 08
  DISMINUCION_VALOR // 09
  OTROS // 10
}

enum TipoNotaDebito {
  INTERES_MORA // 01
  AUMENTO_VALOR // 02
  PENALIDADES // 03
  OTROS // 10
}

// ============================================
// CONFIGURACIÓN DEL SISTEMA
// ============================================

model SystemConfig {
  key         String   @id
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}

// ============================================
// EMPRESA (DATOS DEL RESTAURANT)
// ============================================

model Company {
  id              String  @id @default(uuid())
  ruc             String  @unique @db.VarChar(11)
  razonSocial     String  @db.VarChar(255)
  nombreComercial String? @db.VarChar(255)
  direccion       String  @db.VarChar(500)
  ubigeo          String  @db.VarChar(6)
  distrito        String  @db.VarChar(100)
  provincia       String  @db.VarChar(100)
  departamento    String  @db.VarChar(100)
  telefono        String? @db.VarChar(20)
  email           String? @db.VarChar(100)
  web             String? @db.VarChar(255)

  // Configuración SUNAT
  usuarioSol          String  @db.VarChar(50)
  claveSol            String  @db.VarChar(100)
  certificadoPem      String? @db.Text
  certificadoPassword String? @db.VarChar(100)

  // Endpoints SUNAT
  endpointBeta       String? @db.VarChar(500)
  endpointProduccion String? @db.VarChar(500)
  modoProduccion     Boolean @default(false)

  // Logo y configuración
  logoPath String? @db.VarChar(500)
  activo   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branches       Branch[]
  configurations CompanyConfiguration[]
  invoices       Invoice[]
  boletas        Boleta[]
  notasCredito   NotaCredito[]
  notasDebito    NotaDebito[]
  dailySummaries DailySummary[]

  @@map("companies")
}

// ============================================
// CONFIGURACIONES ESPECÍFICAS POR EMPRESA
// ============================================

enum ConfigType {
  TAX_SETTINGS
  INVOICE_SETTINGS
  DOCUMENT_SETTINGS
}

enum Environment {
  GENERAL
  BETA
  PRODUCCION
}

model CompanyConfiguration {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  configType  ConfigType
  environment Environment @default(GENERAL)
  configData  Json // Datos de configuración flexibles

  isActive    Boolean @default(true)
  description String? @db.VarChar(255)
  priority    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, configType, environment])
  @@index([companyId, configType])
  @@map("company_configurations")
}

// ============================================
// SUCURSALES (PISOS DEL RESTAURANT)
// ============================================

model Branch {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  codigo       String  @db.VarChar(10)
  nombre       String  @db.VarChar(255)
  direccion    String  @db.VarChar(500)
  ubigeo       String  @db.VarChar(6)
  distrito     String  @db.VarChar(100)
  provincia    String  @db.VarChar(100)
  departamento String  @db.VarChar(100)
  telefono     String? @db.VarChar(20)
  email        String? @db.VarChar(100)

  // Series documentarias (JSON arrays)
  seriesFactura     Json? // ["F001", "F002"]
  seriesBoleta      Json? // ["B001", "B002"]
  seriesNotaCredito Json? // ["FC01", "BC01"]
  seriesNotaDebito  Json? // ["FD01", "BD01"]

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  floors       Floor[]
  correlatives Correlative[]
  invoices     Invoice[]
  boletas      Boleta[]
  notasCredito NotaCredito[]
  notasDebito  NotaDebito[]

  @@unique([companyId, codigo])
  @@map("branches")
}

// ============================================
// CORRELATIVOS DE SERIES
// ============================================

model Correlative {
  id       String @id @default(uuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  tipoDocumento     String @db.VarChar(2) // 01=Factura, 03=Boleta, 07=NC, 08=ND
  serie             String @db.VarChar(4)
  correlativoActual Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, tipoDocumento, serie])
  @@index([branchId, tipoDocumento])
  @@map("correlatives")
}

// ============================================
// PISOS
// ============================================

model Floor {
  id       String @id @default(uuid())
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  name     String
  level    Int
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tables     Table[]
  users      User[]
  categories Category[]

  @@unique([branchId, level])
  @@map("floors")
}

// ============================================
// USUARIOS
// ============================================

model User {
  id       String   @id @default(uuid())
  name     String
  dni      String   @unique
  username String   @unique
  password String
  role     UserRole @default(MESERO)
  isActive Boolean  @default(true)

  lastLoginAt         DateTime?
  lastLoginIp         String?   @db.VarChar(45)
  failedLoginAttempts Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  floors                  Floor[]
  orders                  Order[]
  sales                   Sale[]
  sessions                CashRegister[]
  invoices                Invoice[]
  boletas                 Boleta[]
  notasCredito            NotaCredito[]
  notasDebito             NotaDebito[]
  authorizedCancellations OrderCancellation[] @relation("AuthorizedBy")

  @@map("users")
}

// ============================================
// CATEGORÍAS DE PRODUCTOS
// ============================================

model Category {
  id       String  @id @default(uuid())
  name     String
  slug     String
  parentId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")
  products Product[]
  floors   Floor[]

  @@map("categories")
}

// ============================================
// PRODUCTOS
// ============================================

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])

  // Código SUNAT (catálogo 25)
  unidadMedida   String  @default("NIU") @db.VarChar(3) // NIU=Unidad, ZZ=Servicio
  codigoProducto String? @db.VarChar(30) // Código interno
  codigoSunat    String? @db.VarChar(30) // Código SUNAT si aplica

  // Impuestos
  afectacionIgv String @default("10") @db.VarChar(2) // 10=Gravado, 20=Exonerado, 30=Inafecto

  isStockManaged Boolean   @default(true)
  stockDaily     Int       @default(0)
  stockWarehouse Int       @default(0)
  isActive       Boolean   @default(true)
  areaOrder      AreaOrder @default(COCINA)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems       OrderItem[]
  variants         ProductVariant[]
  invoiceItems     InvoiceItem[]
  boletaItems      BoletaItem[]
  notaCreditoItems NotaCreditoItem[]
  notaDebitoItems  NotaDebitoItem[]

  @@index([categoryId])
  @@index([codigoProducto])
  @@map("products")
}

// ============================================
// VARIANTES DEL PRODUCTO
// ============================================

model ProductVariant {
  id         String  @id @default(uuid())
  name       String
  priceExtra Decimal @default(0.00) @db.Decimal(10, 2)
  isActive   Boolean @default(true)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_variants")
}

// ============================================
// MESAS
// ============================================

model Table {
  id       String      @id @default(uuid())
  number   Int
  name     String
  status   TableStatus @default(LIBRE)
  capacity Int         @default(4)
  isActive Boolean     @default(true)

  floorId String
  floor   Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@unique([floorId, number])
  @@index([floorId, status])
  @@map("tables")
}

// ============================================
// ÓRDENES (COMANDAS)
// ============================================

model Order {
  id          String      @id @default(uuid())
  status      OrderStatus @default(PENDIENTE)
  dailyNumber Int
  orderDate   DateTime    @default(now())

  tableId String
  table   Table  @relation(fields: [tableId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items             OrderItem[]
  sale              Sale?
  orderCancellation OrderCancellation?

  @@unique([dailyNumber, orderDate, tableId])
  @@index([orderDate, dailyNumber])
  @@index([tableId, status])
  @@map("orders")
}

model OrderCancellation {
  id     String @id @default(uuid())
  reason String @db.Text

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  authorizedById String?
  authorizedBy   User?   @relation("AuthorizedBy", fields: [authorizedById], references: [id])

  cancelledAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("order_cancellations")
}

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity       Int
  price          Decimal @db.Decimal(10, 2)
  notes          String? @db.Text
  variantsDetail Json? // Detalles de variantes seleccionadas

  isActive  Boolean   @default(true)
  areaOrder AreaOrder @default(COCINA)
  isPrinted Boolean   @default(false) // Para control de impresión en cocina
  printedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  saleId String?
  sale   Sale?   @relation(fields: [saleId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([areaOrder, isPrinted])
  @@map("order_items")
}

// ============================================
// CLIENTES
// ============================================

model Client {
  id              String                 @id @default(uuid())
  tipoDocumento   TipoDocumentoIdentidad @default(SIN_DOC)
  numeroDocumento String                 @unique @db.VarChar(15)
  razonSocial     String                 @db.VarChar(500)
  nombreComercial String?                @db.VarChar(255)

  direccion    String? @db.VarChar(500)
  ubigeo       String? @db.VarChar(6)
  distrito     String? @db.VarChar(100)
  provincia    String? @db.VarChar(100)
  departamento String? @db.VarChar(100)

  email    String? @db.VarChar(100)
  telefono String? @db.VarChar(20)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sales        Sale[]
  invoices     Invoice[]
  boletas      Boleta[]
  notasCredito NotaCredito[]
  notasDebito  NotaDebito[]

  @@index([tipoDocumento, numeroDocumento])
  @@index([razonSocial])
  @@map("clients")
}

// ============================================
// VENTAS (RELACIÓN CON ÓRDENES)
// ============================================

model Sale {
  id                String          @id @default(uuid())
  type              ComprobanteType
  serie             String          @db.VarChar(4)
  correlativo       Int
  numeroComprobante String          @unique

  fechaEmision DateTime @default(now())
  tipoMoneda   String   @default("PEN") @db.VarChar(3)

  // Pagos
  montoPagado   Decimal?      @db.Decimal(12, 2)
  vuelto        Decimal?      @db.Decimal(12, 2)
  paymentMethod PaymentMethod
  formaPago     String        @default("Contado") @db.VarChar(20)
  cuotas        Json?

  // Montos calculados
  montoGravado     Decimal @default(0.00) @db.Decimal(12, 2)
  montoExonerado   Decimal @default(0.00) @db.Decimal(12, 2)
  montoInafecto    Decimal @default(0.00) @db.Decimal(12, 2)
  igv              Decimal @default(0.00) @db.Decimal(12, 2)
  icbper           Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos   Decimal @default(0.00) @db.Decimal(12, 2)
  valorVenta       Decimal @default(0.00) @db.Decimal(12, 2)
  precioVentaTotal Decimal @default(0.00) @db.Decimal(12, 2)

  montoLetras   String @db.VarChar(255)
  itemsSnapshot Json // Snapshot de items al momento de la venta

  // Archivos generados
  xmlFileName String? @db.VarChar(255)
  xmlPath     String? @db.VarChar(500)
  pdfPath     String? @db.VarChar(500)
  cdrPath     String? @db.VarChar(500)

  // Respuesta SUNAT (si aplica)
  cdrCode        String? @db.VarChar(10)
  cdrDescription String? @db.Text
  cdrNotes       String? @db.Text
  hash           String? @db.VarChar(100)
  errorCodigo    String? @db.VarChar(10)
  errorMensaje   String? @db.Text

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  orderId String? @unique
  order   Order?  @relation(fields: [orderId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  orderItems OrderItem[]

  // Relación con documentos electrónicos
  invoiceId String?  @unique
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  boletaId String? @unique
  boleta   Boleta? @relation(fields: [boletaId], references: [id])

  @@index([fechaEmision])
  @@index([numeroComprobante])
  @@index([userId])
  @@index([clientId])
  @@map("sales")
}

// ============================================
// FACTURAS ELECTRÓNICAS (Tipo 01)
// ============================================

model Invoice {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Identificación
  tipoDocumento  String @default("01") @db.VarChar(2)
  serie          String @db.VarChar(4)
  correlativo    String @db.VarChar(8)
  numeroCompleto String @unique @db.VarChar(15) // F001-00000001

  // Fechas
  fechaEmision     DateTime  @default(now())
  fechaVencimiento DateTime?

  // Configuración UBL
  ublVersion    String @default("2.1") @db.VarChar(3)
  tipoOperacion String @default("0101") @db.VarChar(4)
  moneda        String @default("PEN") @db.VarChar(3)

  // Forma de pago
  formaPagoTipo   String @default("Contado") @db.VarChar(20)
  formaPagoCuotas Json?

  // Montos calculados
  valorVenta         Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperGravadas    Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperExoneradas  Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperInafectas   Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperExportacion Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperGratuitas   Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgvGratuitas    Decimal @default(0.00) @db.Decimal(10, 2)
  mtoIgv             Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIsc             Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIcbper          Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOtrosTributos   Decimal @default(0.00) @db.Decimal(12, 2)
  mtoBaseIvap        Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIvap            Decimal @default(0.00) @db.Decimal(12, 2)
  mtoDetraccion      Decimal @default(0.00) @db.Decimal(12, 2)
  mtoPercepcion      Decimal @default(0.00) @db.Decimal(12, 2)
  mtoRetencion       Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos     Decimal @default(0.00) @db.Decimal(12, 2)
  subTotal           Decimal @default(0.00) @db.Decimal(12, 2)
  mtoImpVenta        Decimal @default(0.00) @db.Decimal(12, 2)
  mtoAnticipos       Decimal @default(0.00) @db.Decimal(12, 2)

  // Detalles JSON
  leyendas               Json?
  guias                  Json?
  documentosRelacionados Json?
  detraccion             Json?
  percepcion             Json?
  retencion              Json?
  datosAdicionales       Json?

  // Archivos
  xmlPath String? @db.VarChar(500)
  cdrPath String? @db.VarChar(500)
  pdfPath String? @db.VarChar(500)

  // Estado SUNAT
  estadoSunat    EstadoSunat @default(PENDIENTE)
  respuestaSunat String?     @db.Text
  codigoHash     String?     @db.VarChar(100)

  // Consulta CPE
  consultaCpeEstado    String?   @db.VarChar(50)
  consultaCpeRespuesta Json?
  consultaCpeFecha     DateTime?

  // Auditoría
  usuarioCreacion String? @db.VarChar(100)
  userId          String
  user            User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  items        InvoiceItem[]
  notasCredito NotaCredito[] @relation("FacturaReferencia")
  notasDebito  NotaDebito[]  @relation("FacturaReferencia")
  sale         Sale?

  @@unique([companyId, serie, correlativo])
  @@index([companyId, branchId])
  @@index([fechaEmision])
  @@index([estadoSunat])
  @@index([numeroCompleto])
  @@map("invoices")
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  cantidad       Decimal @db.Decimal(12, 3)
  unidadMedida   String  @db.VarChar(3)
  codigoProducto String? @db.VarChar(30)
  descripcion    String  @db.VarChar(500)

  // Precios
  mtoValorUnitario  Decimal @db.Decimal(12, 10)
  mtoPrecioUnitario Decimal @db.Decimal(12, 10)
  mtoValorVenta     Decimal @db.Decimal(12, 2)

  // Impuestos
  afectacionIgv  String  @db.VarChar(2)
  porcentajeIgv  Decimal @default(18.00) @db.Decimal(5, 2)
  mtoBaseIgv     Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv         Decimal @default(0.00) @db.Decimal(12, 2)
  tipoSistemaIsc String? @db.VarChar(2)
  mtoIsc         Decimal @default(0.00) @db.Decimal(12, 2)
  icbper         Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos Decimal @default(0.00) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@map("invoice_items")
}

// ============================================
// BOLETAS ELECTRÓNICAS (Tipo 03)
// ============================================

model Boleta {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  dailySummaryId String?
  dailySummary   DailySummary? @relation(fields: [dailySummaryId], references: [id])

  // Identificación
  tipoDocumento  String @default("03") @db.VarChar(2)
  serie          String @db.VarChar(4)
  correlativo    String @db.VarChar(8)
  numeroCompleto String @unique @db.VarChar(15)

  fechaEmision DateTime @default(now())

  // Configuración
  ublVersion    String @default("2.1") @db.VarChar(3)
  tipoOperacion String @default("0101") @db.VarChar(4)
  moneda        String @default("PEN") @db.VarChar(3)
  metodoEnvio   String @default("individual") @db.VarChar(20)

  // Montos
  valorVenta        Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperGravadas   Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperExoneradas Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperInafectas  Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperGratuitas  Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgvGratuitas   Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv            Decimal @default(0.00) @db.Decimal(12, 2)
  mtoBaseIvap       Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIvap           Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIsc            Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIcbper         Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos    Decimal @default(0.00) @db.Decimal(12, 2)
  subTotal          Decimal @default(0.00) @db.Decimal(12, 2)
  mtoImpVenta       Decimal @default(0.00) @db.Decimal(12, 2)

  // JSON
  leyendas         Json?
  datosAdicionales Json?

  // Archivos
  xmlPath String? @db.VarChar(500)
  cdrPath String? @db.VarChar(500)
  pdfPath String? @db.VarChar(500)

  // Estado
  estadoSunat    EstadoSunat @default(PENDIENTE)
  respuestaSunat String?     @db.Text
  codigoHash     String?     @db.VarChar(100)

  consultaCpeEstado    String?   @db.VarChar(50)
  consultaCpeRespuesta Json?
  consultaCpeFecha     DateTime?

  usuarioCreacion String? @db.VarChar(100)
  userId          String
  user            User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items        BoletaItem[]
  notasCredito NotaCredito[] @relation("BoletaReferencia")
  sale         Sale?

  @@unique([companyId, serie, correlativo])
  @@index([companyId, branchId])
  @@index([fechaEmision])
  @@index([estadoSunat])
  @@index([dailySummaryId])
  @@map("boletas")
}

model BoletaItem {
  id       String @id @default(uuid())
  boletaId String
  boleta   Boleta @relation(fields: [boletaId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  cantidad       Decimal @db.Decimal(12, 3)
  unidadMedida   String  @db.VarChar(3)
  codigoProducto String? @db.VarChar(30)
  descripcion    String  @db.VarChar(500)

  mtoValorUnitario  Decimal @db.Decimal(12, 10)
  mtoPrecioUnitario Decimal @db.Decimal(12, 10)
  mtoValorVenta     Decimal @db.Decimal(12, 2)

  afectacionIgv  String  @db.VarChar(2)
  porcentajeIgv  Decimal @default(18.00) @db.Decimal(5, 2)
  mtoBaseIgv     Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv         Decimal @default(0.00) @db.Decimal(12, 2)
  icbper         Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos Decimal @default(0.00) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([boletaId])
  @@map("boleta_items")
}

// ============================================
// NOTAS DE CRÉDITO (Tipo 07)
// ============================================

model NotaCredito {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  // Identificación
  tipoDocumento  String @default("07") @db.VarChar(2)
  serie          String @db.VarChar(4)
  correlativo    String @db.VarChar(8)
  numeroCompleto String @unique @db.VarChar(15)

  fechaEmision DateTime @default(now())

  // Documento relacionado
  tipoDocumentoRel  String @db.VarChar(2) // 01=Factura, 03=Boleta
  serieRel          String @db.VarChar(4)
  correlativoRel    String @db.VarChar(8)
  numeroCompletoRel String @db.VarChar(15)

  facturaId String?
  factura   Invoice? @relation("FacturaReferencia", fields: [facturaId], references: [id])

  boletaId String?
  boleta   Boleta? @relation("BoletaReferencia", fields: [boletaId], references: [id])

  // Tipo y motivo
  tipoNotaCredito TipoNotaCredito
  motivoNota      String          @db.VarChar(500)

  // Configuración
  ublVersion    String @default("2.1") @db.VarChar(3)
  tipoOperacion String @default("0101") @db.VarChar(4)
  moneda        String @default("PEN") @db.VarChar(3)

  // Montos
  valorVenta        Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperGravadas   Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperExoneradas Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperInafectas  Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv            Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIcbper         Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos    Decimal @default(0.00) @db.Decimal(12, 2)
  mtoImpVenta       Decimal @default(0.00) @db.Decimal(12, 2)

  // JSON
  leyendas         Json?
  datosAdicionales Json?

  // Archivos
  xmlPath String? @db.VarChar(500)
  cdrPath String? @db.VarChar(500)
  pdfPath String? @db.VarChar(500)

  // Estado
  estadoSunat    EstadoSunat @default(PENDIENTE)
  respuestaSunat String?     @db.Text
  codigoHash     String?     @db.VarChar(100)

  usuarioCreacion String? @db.VarChar(100)
  userId          String
  user            User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items NotaCreditoItem[]

  @@unique([companyId, serie, correlativo])
  @@index([companyId, branchId])
  @@index([fechaEmision])
  @@index([facturaId])
  @@index([boletaId])
  @@map("notas_credito")
}

model NotaCreditoItem {
  id            String      @id @default(uuid())
  notaCreditoId String
  notaCredito   NotaCredito @relation(fields: [notaCreditoId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  cantidad       Decimal @db.Decimal(12, 3)
  unidadMedida   String  @db.VarChar(3)
  codigoProducto String? @db.VarChar(30)
  descripcion    String  @db.VarChar(500)

  mtoValorUnitario  Decimal @db.Decimal(12, 10)
  mtoPrecioUnitario Decimal @db.Decimal(12, 10)
  mtoValorVenta     Decimal @db.Decimal(12, 2)

  afectacionIgv  String  @db.VarChar(2)
  mtoBaseIgv     Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv         Decimal @default(0.00) @db.Decimal(12, 2)
  icbper         Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos Decimal @default(0.00) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([notaCreditoId])
  @@map("nota_credito_items")
}

// ============================================
// NOTAS DE DÉBITO (Tipo 08)
// ============================================

model NotaDebito {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  tipoDocumento  String @default("08") @db.VarChar(2)
  serie          String @db.VarChar(4)
  correlativo    String @db.VarChar(8)
  numeroCompleto String @unique @db.VarChar(15)

  fechaEmision DateTime @default(now())

  // Documento relacionado
  tipoDocumentoRel  String @db.VarChar(2)
  serieRel          String @db.VarChar(4)
  correlativoRel    String @db.VarChar(8)
  numeroCompletoRel String @db.VarChar(15)

  facturaId String?
  factura   Invoice? @relation("FacturaReferencia", fields: [facturaId], references: [id])

  // Tipo y motivo
  tipoNotaDebito TipoNotaDebito
  motivoNota     String         @db.VarChar(500)

  // Configuración
  ublVersion    String @default("2.1") @db.VarChar(3)
  tipoOperacion String @default("0101") @db.VarChar(4)
  moneda        String @default("PEN") @db.VarChar(3)

  // Montos
  valorVenta      Decimal @default(0.00) @db.Decimal(12, 2)
  mtoOperGravadas Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv          Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos  Decimal @default(0.00) @db.Decimal(12, 2)
  mtoImpVenta     Decimal @default(0.00) @db.Decimal(12, 2)

  // JSON
  leyendas         Json?
  datosAdicionales Json?

  // Archivos
  xmlPath String? @db.VarChar(500)
  cdrPath String? @db.VarChar(500)
  pdfPath String? @db.VarChar(500)

  // Estado
  estadoSunat    EstadoSunat @default(PENDIENTE)
  respuestaSunat String?     @db.Text
  codigoHash     String?     @db.VarChar(100)

  usuarioCreacion String? @db.VarChar(100)
  userId          String
  user            User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items NotaDebitoItem[]

  @@unique([companyId, serie, correlativo])
  @@index([companyId, branchId])
  @@index([facturaId])
  @@map("notas_debito")
}

model NotaDebitoItem {
  id           String     @id @default(uuid())
  notaDebitoId String
  notaDebito   NotaDebito @relation(fields: [notaDebitoId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  cantidad       Decimal @db.Decimal(12, 3)
  unidadMedida   String  @db.VarChar(3)
  codigoProducto String? @db.VarChar(30)
  descripcion    String  @db.VarChar(500)

  mtoValorUnitario  Decimal @db.Decimal(12, 10)
  mtoPrecioUnitario Decimal @db.Decimal(12, 10)
  mtoValorVenta     Decimal @db.Decimal(12, 2)

  afectacionIgv  String  @db.VarChar(2)
  mtoBaseIgv     Decimal @default(0.00) @db.Decimal(12, 2)
  mtoIgv         Decimal @default(0.00) @db.Decimal(12, 2)
  totalImpuestos Decimal @default(0.00) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([notaDebitoId])
  @@map("nota_debito_items")
}

// ============================================
// RESÚMENES DIARIOS (RC)
// ============================================

model DailySummary {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Identificación
  identificador   String   @unique @db.VarChar(20) // RC-20241228-001
  fechaEmision    DateTime @default(now())
  fechaReferencia DateTime // Fecha de las boletas incluidas

  // Archivos
  xmlPath String? @db.VarChar(500)
  cdrPath String? @db.VarChar(500)

  // Estado
  estadoSunat    EstadoSunat @default(PENDIENTE)
  respuestaSunat String?     @db.Text
  ticket         String?     @db.VarChar(50) // Ticket SUNAT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  boletas Boleta[]

  @@index([fechaReferencia])
  @@index([estadoSunat])
  @@map("daily_summaries")
}

// ============================================
// CAJA REGISTRADORA
// ============================================

model CashRegister {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  openTime  DateTime  @default(now())
  closeTime DateTime?

  initialMoney Decimal  @db.Decimal(10, 2)
  systemMoney  Decimal? @db.Decimal(10, 2)
  finalMoney   Decimal? @db.Decimal(10, 2)
  difference   Decimal? @db.Decimal(10, 2)

  status CashRegisterStatus @default(ABIERTA)
  notes  String?            @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movements CashMovement[]

  @@index([userId, status])
  @@index([openTime])
  @@map("cash_registers")
}

model CashMovement {
  id             String       @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)

  amount      Decimal          @db.Decimal(10, 2)
  type        CashMovementType
  description String           @db.Text
  isAutomatic Boolean          @default(false)

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cashRegisterId, type])
  @@index([createdAt])
  @@map("cash_movements")
}

// ============================================
// UBIGEO PERÚ (CATÁLOGOS SUNAT)
// ============================================

model UbiRegion {
  id     String @id @default(uuid())
  codigo String @unique @db.VarChar(2)
  nombre String @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  provincias UbiProvincia[]

  @@index([nombre])
  @@map("ubi_regiones")
}

model UbiProvincia {
  id       String    @id @default(uuid())
  regionId String
  region   UbiRegion @relation(fields: [regionId], references: [id], onDelete: Cascade)

  codigo String @unique @db.VarChar(4)
  nombre String @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  distritos UbiDistrito[]

  @@index([regionId])
  @@index([nombre])
  @@map("ubi_provincias")
}

model UbiDistrito {
  id          String       @id @default(uuid())
  provinciaId String
  provincia   UbiProvincia @relation(fields: [provinciaId], references: [id], onDelete: Cascade)

  codigo String @unique @db.VarChar(6) // Código UBIGEO completo
  nombre String @db.VarChar(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([provinciaId])
  @@index([nombre])
  @@map("ubi_distritos")
}
